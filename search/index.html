<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Search · Corridor Ledger</title>

  <!-- Site styles -->
  <link rel="stylesheet" href="/main.css"/>

  <!-- Pagefind UI assets (must be present at /pagefind/*) -->
  <link rel="stylesheet" href="/pagefind/pagefind-ui.css">
  <script defer src="/pagefind/pagefind-ui.js"></script>

  <style>
    /* Theme match for Pagefind UI */
    .pagefind-ui__form,
    .pagefind-ui__search-input,
    .pagefind-ui__results-area,
    .pagefind-ui__drawer { background: var(--paper); color: var(--ink); }
    .pagefind-ui__search-input { border:1px solid var(--border); border-radius:10px; }
    .pagefind-ui__result-excerpt mark,
    .pagefind-ui__search-clear { background: transparent; color: var(--link); }
    html[data-theme="dark"] .pagefind-ui__search-input { border-color:#333; }

    /* Friendly hint only if the index truly isn't available */
    .pf-problem {
      margin-top: 12px; padding: 10px 12px;
      border: 1px dashed var(--border); border-radius: 10px;
      color: var(--muted);
      display: none; /* hidden by default */
    }
  </style>
</head>
<body>
  <header class="site-header">
    <div class="brand">
      <button class="icon-btn menu-btn" id="menuToggle" aria-label="Open menu" aria-expanded="false" aria-controls="dropdown">☰</button>
      <a class="logo-link" href="/" aria-label="Corridor Ledger home">
        <img src="/wordmark_header_1200w.png" class="wordmark wordmark-light" alt="Corridor Ledger">
        <img src="/wordmark_header_dark_1200w.png" class="wordmark wordmark-dark" alt="Corridor Ledger">
      </a>
      <button class="icon-btn theme-btn" id="themeToggle" aria-label="Toggle dark mode">
        <img src="/sun_grunge_black_transparent.png" class="theme-icon theme-icon-sun" alt="">
        <img src="/moon_grunge_white_transparent.png" class="theme-icon theme-icon-moon" alt="">
      </button>
    </div>

    <nav class="nav desktop-nav" aria-label="Primary">
      <a href="/">Home</a>
      <a href="/mechanisms/">Mechanisms</a>
      <a href="/figures/">Figures</a>
      <a href="/numbers/">Numbers</a>
      <a href="/dossiers/">Dossiers</a>
      <a href="/tips/">Tips</a>
    </nav>

    <div class="dropdown" id="dropdown" aria-hidden="true">
      <form class="dropdown-search" role="search" aria-label="Site search" action="/search/" method="GET">
        <input class="search-input" type="search" name="q" placeholder="Search Corridor Ledger" />
      </form>
      <nav class="dropdown-nav">
        <a href="/" data-route="/">Home</a>
        <a href="/mechanisms/" data-route="/mechanisms/">Mechanisms</a>
        <a href="/figures/" data-route="/figures/">Figures</a>
        <a href="/numbers/" data-route="/numbers/">Numbers</a>
        <a href="/dossiers/" data-route="/dossiers/">Dossiers</a>
        <a href="/tips/" data-route="/tips/">Tips</a>
      </nav>
    </div>
    <div class="dropdown-backdrop" id="backdrop" aria-hidden="true"></div>
  </header>

  <main class="container" data-pagefind-body>
    <section class="rail">
      <article class="hero hero-center">
        <h1 class="headline">Search</h1>
        <p class="dek">Find issues, articles, and explainers.</p>

        <!-- Pagefind UI mounts here -->
        <div id="search"></div>

        <!-- Only shown if the index truly can't be reached after retries -->
        <div id="pfNotice" class="pf-problem">
          Can’t load the search index. Make sure your GitHub Action created
          <code>/pagefind/</code> and that
          <a href="/pagefind/manifest.json" rel="nofollow">/pagefind/manifest.json</a>
          returns 200.
        </div>
      </article>
    </section>
  </main>

  <footer class="site-footer">
    <div class="foot-left">
      <a href="/feed.xml">RSS</a> · <a href="/corrections/">Corrections</a> ·
      <a href="mailto:editor@corridorledger.com">Editor</a> · <a href="/tips/">Tips</a>
    </div>
    <div class="foot-right">© 2025 Corridor Ledger</div>
  </footer>

  <script>
    // ===== Theme init =====
    const root = document.documentElement;
    (function initTheme(){
      const saved = localStorage.getItem('cl-theme');
      if (saved === 'dark' || saved === 'light') root.setAttribute('data-theme', saved);
      else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
        root.setAttribute('data-theme','dark');
      }
    })();
    document.getElementById('themeToggle').addEventListener('click', () => {
      const next = root.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
      root.setAttribute('data-theme', next); localStorage.setItem('cl-theme', next);
    });

    // ===== Menu dropdown =====
    const menuToggle = document.getElementById('menuToggle');
    const dropdown   = document.getElementById('dropdown');
    const backdrop   = document.getElementById('backdrop');
    function openDropdown(open){
      dropdown.classList.toggle('open', open);
      backdrop.classList.toggle('show', open);
      menuToggle.setAttribute('aria-expanded', open ? 'true' : 'false');
      dropdown.setAttribute('aria-hidden', open ? 'false' : 'true');
      document.body.classList.toggle('no-scroll', open);
      if (open) { markActive(); dropdown.querySelector('.search-input')?.focus(); }
    }
    function markActive(){
      const path = (location.pathname.replace(/\/+$/,'/') || '/');
      document.querySelectorAll('.dropdown-nav [data-route]').forEach(a=>{
        const r = a.getAttribute('data-route');
        a.classList.toggle('active', (r==='/'&&path==='/') || (r!=='/'&&path.startsWith(r)));
      });
    }
    menuToggle.addEventListener('click', ()=>openDropdown(!dropdown.classList.contains('open')));
    backdrop.addEventListener('click', ()=>openDropdown(false));
    document.addEventListener('keydown', e=>{ if(e.key==='Escape') openDropdown(false); });
    dropdown.addEventListener('click', e=>{ if(e.target.tagName==='A') openDropdown(false); });

    // ===== Pagefind UI + robust index check =====
    function waitFor(selector, timeout=1500){
      return new Promise((resolve)=>{
        const t0 = performance.now();
        const i = setInterval(()=>{
          const el = document.querySelector(selector);
          if (el) { clearInterval(i); resolve(el); }
          else if (performance.now()-t0 > timeout) { clearInterval(i); resolve(null); }
        }, 30);
      });
    }

    async function checkManifestWithRetries(retries=4){
      const notice = document.getElementById('pfNotice');
      for (let i = 0; i < retries; i++){
        try{
          const bust = Date.now();
          const r = await fetch(`/pagefind/manifest.json?bust=${bust}`, { cache: 'no-store' });
          if (r.ok) { notice.style.display = 'none'; return true; }
        }catch(_){}
        await new Promise(r => setTimeout(r, 400 * (i + 1)));
      }
      notice.style.display = 'block';
      return false;
    }

    document.addEventListener('DOMContentLoaded', async () => {
      // Initialize Pagefind UI
      new PagefindUI({
        element: "#search",
        showImages: false,
        translations: { placeholder: "Search Corridor Ledger" }
      });

      // Hydrate from ?q=
      const q = new URLSearchParams(location.search).get('q');
      if (q) {
        const input = await waitFor('.pagefind-ui__search-input');
        if (input) {
          input.value = q;
          input.dispatchEvent(new Event('input', { bubbles: true }));
        }
      }

      // Check index; if CDN was slow, we also re-check after a bit
      const ok = await checkManifestWithRetries();
      if (!ok) {
        // try one last time after Pagefind has likely warmed caches
        setTimeout(checkManifestWithRetries, 2000);
      }
    });
  </script>
</body>
</html>
